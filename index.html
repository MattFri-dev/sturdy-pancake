<!DOCTYPE html>
<html>
<head>
  <title>GIBS GHRSST WMS Layer Dates</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background-color: rgba(240, 248, 255, 0.85); /* semi-transparent */
    }
    h2 {
      color: #003366;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .layer-date {
      background-color: #ffffffcc;
      border-left: 5px solid #0077cc;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }
    .layer-date strong {
      font-size: 18px;
      color: #003366;
    }
    .legend {
      margin-top: 10px;
      text-align: center;
    }
    .legend img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h2>Latest Imagery Dates from GIBS WMS (GHRSST Layers)</h2>
  <div id="results">Loading...</div>

  <script>
    const WMS_NS = "http://www.opengis.net/wms";
    const layerInfo = {
      "GHRSST_L4_MUR_Sea_Ice_Concentration": {
        title: "Sea Ice Concentration (L4, MUR, GHRSST)",
        legend: "https://gibs.earthdata.nasa.gov/legends/GHRSST_Sea_Ice_Concentration_H.png"
      },
      "GHRSST_L4_MUR_Sea_Surface_Temperature": {
        title: "Sea Surface Temperature (L4, MUR Global Foundation, GHRSST)",
        legend: "https://gibs.earthdata.nasa.gov/legends/GHRSST_Sea_Surface_Temperature_H.png"
      },
      "GHRSST_L4_MUR_Sea_Surface_Temperature_Anomalies": {
        title: "Sea Surface Temperature Anomalies (L4, MUR, GHRSST)",
        legend: "https://gibs.earthdata.nasa.gov/legends/GHRSST_Sea_Surface_Temperature_Anomalies_H.png"
      }
    };

    const seenLayers = new Set();

    function findMatchingLayers(layerNodes) {
      let output = "";

      for (let i = 0; i < layerNodes.length; i++) {
        const layer = layerNodes[i];
        const nameEl = layer.getElementsByTagNameNS(WMS_NS, "Name")[0];

        // Check for direct child layers
        const directChildLayers = Array.from(layer.childNodes).filter(
          node => node.nodeType === 1 && node.localName === "Layer"
        );

        // Only process leaf layers with a Name and no direct children
        if (nameEl && layerInfo[nameEl.textContent] && directChildLayers.length === 0 && !seenLayers.has(nameEl.textContent)) {
          seenLayers.add(nameEl.textContent);

          const dimensionEls = layer.getElementsByTagNameNS(WMS_NS, "Dimension");
          for (let j = 0; j < dimensionEls.length; j++) {
            const dim = dimensionEls[j];
            if (dim.getAttribute("name") === "time") {
              const defaultDate = dim.getAttribute("default");
              const info = layerInfo[nameEl.textContent];
              output += `
                <div class="layer-date">
                  <strong>${info.title}</strong>: ${defaultDate}
                  <div class="legend">
                    <img src="${info.legend}" alt="Legend for ${info.title}" />
                  </div>
                </div>
              `;
            }
          }
        }

        // Recursively search direct child layers
        if (directChildLayers.length > 0) {
          output += findMatchingLayers(directChildLayers);
        }
      }

      return output;
    }

    fetch("https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi?SERVICE=WMS&REQUEST=GetCapabilities")
      .then(response => response.text())
      .then(xmlText => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        const topLayer = xmlDoc.getElementsByTagNameNS(WMS_NS, "Layer")[0];
        const nestedLayers = Array.from(topLayer.childNodes).filter(
          node => node.nodeType === 1 && node.localName === "Layer"
        );

        const output = findMatchingLayers(nestedLayers);
        document.getElementById("results").innerHTML = output || "No matching layers found.";
      })
      .catch(err => {
        console.error("Error fetching WMS capabilities:", err);
        document.getElementById("results").innerText = "Failed to load imagery dates.";
      });
  </script>
</body>
</html>
